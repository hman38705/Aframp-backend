name: Branch Protection

on:
    workflow_dispatch:

jobs:
    enforce-protection:
        name: Enforce branch protection
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            administration: write
        steps:
            - name: "Apply protection to 'develop' branch"
              uses: actions/github-script@v6
              with:
                  script: |
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const branch = 'develop';

                      // configure a simple protection policy: require status checks
                      // and at least one approving review before merge
                      await github.repos.updateBranchProtection({
                        owner,
                        repo,
                        branch,
                        required_status_checks: {
                          strict: true,
                          contexts: [
                            'Ensure PRs target develop',
                            'Lint',
                            'Unit Tests',
                            'Integration Tests (Postgres + Redis)',
                            'Security Scan'
                          ]
                        },
                        enforce_admins: true,
                        required_pull_request_reviews: {
                          require_code_owner_reviews: false,
                          required_approving_review_count: 1
                        },
                        restrictions: null
                      });
                      console.log(`Protection policy applied to ${branch}`);

            - name: "Dump current protection config"
              uses: actions/github-script@v6
              with:
                  script: |
                      const { data } = await github.repos.getBranchProtection({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        branch: 'develop'
                      });
                      console.log(JSON.stringify(data, null, 2));
